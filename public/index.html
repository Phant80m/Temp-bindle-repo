<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <title>Real-time Chat App</title>
    <style>
      body {
        background-color: #1e1e2e;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        position: relative;
        font-family: 'Varela Round', sans-serif;
        overflow-x: hidden;
      }
      #popup {
    position: fixed;
    top: 20px; /* Adjust the distance from the top of the screen */
    right: 20px; /* Adjust the distance from the right of the screen */
    padding: 10px;
    background-color: #ff0000; /* Set the background color of the popup */
    color: #ffffff; /* Set the text color of the popup */
    border-radius: 5px;
    opacity: 0; /* Initially set the popup as hidden */
    z-index: 9999; /* Ensure the popup stays above other elements */
    animation: slideIn 0.3s ease-in-out; /* Use the slideIn animation */
  }

  @keyframes slideIn {
    0% {
      transform: translateX(100%); /* Slide from the right */
    }
    100% {
      transform: translateX(0); /* Slide to the final position */
    }
  }
      .chat-container {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        flex: 1;
        overflow-y: auto;
        /* Use scrollbar when content overflows */
        padding: 15px;
        word-wrap: break-word;
        /* Wrap long words to fit within container */
      }

      .message-wrapper {
        margin-bottom: 10px;
        padding: 5px;
        /* Add padding for each message */
        background-color: #181825;
        padding: 5px;
        border-radius: 5px;
      }

      .username {
        color: #b4befe;
      }

      .timestamp {
        color: #585b70;
      }

      .msgContent {
        color: #cdd6f4;
      }

      .username-timestamp {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        /* Make the username bold */
      }

      .username-timestamp em {
        margin-left: 10px;
        /* Add some space between username and timestamp */
      }

      .Control {
        padding: 10px;
        border-top: solid #181825 2px;
        position: sticky;
        /* Make it sticky */
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-around;
        height: 6%;
        align-items: center;
        background-color: #11111b;
        z-index: 1;
        /* Ensure it stays above the chat messages */
        box-shadow: #11111b 0px -50px 36px -28px inset;
      }

      input {
        background-color: #a6adc8;
        color: #11111b;
        border: none;
        border-radius: 5px;
        padding: 5px;
        margin: 3px;
      }
      #scrollLockButton {
        background-color: #a6e3a1;
      }

      button {
        background-color: #a6adc8;
        color: #11111b;
        border: none;
        border-radius: 5px;
        padding: 5px;
        margin: 3px;
      }

      /* Add more styles to .Control and its child elements as needed */
      textarea:focus,
      input:focus {
        outline: none;
      }

      #message {
        width: 70%;
      }

      #sendButton {
        width: 10%;
      }

      #scrollLockButton {
        width: 10%;
      }
    </style>
  <body>
    <div class="chat-container">
      <div id="chat-messages"></div>
    </div>
    <div class="Control">
      <input type="text" id="username" placeholder="Enter your username">
      <input type="text" id="message" placeholder="Type your message">
      <button id="sendButton">Send</button>
      <button id="scrollLockButton">ScrollUnlock</button>
    </div>
    <div id="popup" class="popup-message">Error sending message!: <br>Reason: contains HTML</div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Socket.IO connection
      const socket = io();
      // DOM elements
      const chatMessages = document.getElementById('chat-messages');
      const usernameInput = document.getElementById('username');
      const messageInput = document.getElementById('message');
      const sendButton = document.getElementById('sendButton');
      const scrollLockButton = document.getElementById('scrollLockButton');
      // Constants for character limits
      const maxUsernameLength = 35;
      const maxMessageLength = 300;
      // Variable to keep track of the scrollLock state
      let scrollLocked = false;
      // Function to toggle scrollLock state
      function toggleScrollLock() {
        scrollLocked = !scrollLocked;
        if (scrollLocked) {
          scrollLockButton.innerText = 'ScrollLock';
          scrollLockButton.style.backgroundColor = '#eba0ac';
        } else {
          scrollLockButton.innerText = 'ScrollUnlock';
          scrollLockButton.style.backgroundColor = '#a6e3a1';
          // If scrollLock is turned off, scroll to the bottom to see new messages
          const scrollingElement = document.scrollingElement || document.body;
          scrollingElement.scrollTop = scrollingElement.scrollHeight;
        }
      }
      // Handle the "ScrollLock" button click event
      scrollLockButton.addEventListener('click', () => {
        toggleScrollLock();
      });
      // Function to add a new message to the chat
      function addMessage(username, message, timestamp) {
        const formattedTimestamp = timestamp.replace(/[\[\]()]/g, '');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message-wrapper');
        messageDiv.innerHTML = `
             
											<div class="username-timestamp">
												<strong class="username">${username}</strong>
												<em class="timestamp">${formattedTimestamp}</em>
											</div>
											<div class="msgContent">${message}</div>
           `;
        messageDiv.querySelector('strong').textContent = username;
        messageDiv.querySelector('em').textContent = formattedTimestamp;
        messageDiv.querySelector('div:last-child').textContent = message;
        chatMessages.appendChild(messageDiv);
      }
      // Load existing messages from the server
      socket.on('loadMessages', (messages) => {
        messages.forEach(({
          username,
          message,
          timestamp
        }) => {
          addMessage(username, message, timestamp);
        });
      });
      // Handle the "Send" button click event
      sendButton.addEventListener('click', () => {
        sendMessage();
      });
      // Handle "Enter" key press in the message input field
      messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault(); // Prevent form submission
          sendMessage();
        }
      });

      function showPopup(message) {
        const popup = document.getElementById('popup');
        popup.textContent = message;
        popup.style.opacity = '1';
        setTimeout(() => {
          popup.style.opacity = '0';
        }, 3000); // Hide the popup after 3 seconds
      }
      // Function to send a message to the server
      function sendMessage() {
        let isOnCooldown = false;
        // Check if the user is currently on cooldown
        if (isOnCooldown) {
          return; // Exit the function without sending the message
        }
        const username = usernameInput.value.trim().slice(0, maxUsernameLength);
        let message = messageInput.value.trim().slice(0, maxMessageLength);
        if (username && message) {
        const linkPattern = /(https?:\/\/[^\s]+\.(com|net|co)[^\s]*)/g;
          const htmlTagsRegex = /<\s*\/?\s*[a-zA-Z]+\s*[^<>]*\s*>/g;
          if (!linkPattern.test(message)) {
            // Check if the message contains HTML tags or ending tags
            if (htmlTagsRegex.test(message)) {
              showPopup('Message not sent: contains HTML');
              return; // Exit the function without sending the message
            }
            socket.emit('sendMessage', {
              username,
              message
            });
            messageInput.value = '';
            // Set the cooldown flag to true
            isOnCooldown = true;
            // Reset the cooldown flag after 0.2 seconds
            setTimeout(() => {
              isOnCooldown = false;
            }, 200);
          } else {
            showPopup('Messages containing links are not allowed.');
          }
        }
      }
      // Handle new messages from the server
      socket.on('newMessage', ({
        username,
        message,
        timestamp
      }) => {
        addMessage(username, message, timestamp);
        if (!scrollLocked) {
          const scrollingElement = document.scrollingElement || document.body;
          scrollingElement.scrollTop = scrollingElement.scrollHeight;
        }
      });
    </script>
  </body>
</html>